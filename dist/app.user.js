// ==UserScript==
// @name       nHentai-Enhanced
// @version    0.0.1
// @author     NekoChan
// @homepage   https://github.com/NekoChanTaiwan/nHentai-Enhanced
// @supportURL https://github.com/NekoChanTaiwan/nHentai-Enhanced/issues
// @match      https://nhentai.net/*
// @namespace  https://github.com/NekoChanTaiwan
// @license    MIT
// @grant      none
// @require    https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js
// @require    https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js
// @require    https://cdn.jsdelivr.net/npm/notyf@3.9.0/notyf.min.js
// @require    https://cdn.jsdelivr.net/gh/821938089/finder@2.0.0.1/finder.js
// ==/UserScript==

(()=>{"use strict";const e=window.$,t=!1,a=[{中文:"/language/chinese/"},{日文:"/language/japanese/"},{英文:"/language/english/"}];let o=null,i=!1,s=0,c=!1,r=new Notyf;function l(a){e(window).scroll((()=>{e(window).scrollTop()+e(window).height()>.75*e(document).height()&&!1===c&&function(a,o=null){switch(s++,a){case"homepage":o=".index-container:nth-child(4)";break;case"page":case"span":o=".index-container"}c=!0,p(`第${s}頁 讀取中`),e.ajax({type:"GET",url:`${location.href}/?page=${s}`,cache:t,dataType:"html",success:t=>{p(`第${s}頁 讀取成功`);let a=e("<div></div>");e(o).append(a.html(t.replaceAll("data-src","src")).find(".gallery")),h(),i&&n.install_blacklisting(),p("隱藏黑名單 已關閉"),c=!1},error:()=>{p(`第${s}頁 讀取失敗`),r.dismissAll(),r.error(`第${s}頁 讀取失敗`),s--,c=!1}})}(a)}))}function h(){e(".gallery > a").attr("target","_blank")}function d(t,n){switch(t){case"homepage":n=".index-container.index-popular";break;case"page":n="#content > div";break;case"span":n=".container.index-container"}e("#content > section").insertBefore(n),e("#content > section > div").remove()}function p(e){console.log(e)}function f(t,n){e(t)[0]?e(t).html(n):p(`修改 HTML 失敗，選擇器：${t}`)}function g(e,t=e.length){for(let n=0;n<t;n++){const t=e.eq(n),a=t.html();o.Tags.hasOwnProperty(a)&&(p(`偵測到：${a}，更改為：${o.Tags[a]}`),t.html(o.Tags[a]).parent().attr("title",a))}}function u(e){const t=o.Book.Time,n=["years","year","months","month","weeks","days","day","hours","hour","minutes","minute","seconds","second","ago"];for(let a=0,o=n.length;a<o;a++)e=e.replace(n[a],t[n[a]]);return e}function m(t,n){!function(t,n){t=function(e){let t=[],n=0,a=e.slice(),o=0;for(const i of e){let e=i.matchAll(/nth\-child\((\d+):(\d+)\)/g);e=Array.from(e),e.length&&(n<e.length&&(n=e.length),a.splice(o,1),o--,t.push(i)),o++}return t.length?a.concat($(t,n)):e}(t);for(const a of t)for(const t of e(a)){const a=e(t);a.text().trim()in n&&a.html(n[a.text().trim()])}}(function(t=[],n){let a=e("body").clone(),o=[];p("自動獲取 CSS 過濾的元素："+(t=[...t,"#messages",".notyf",".notyf-announcer",".gallery",".thumbs","#comment-container"]));for(const n of t)e(n,a).remove();return e("*",a).each((function(){if(0==e("*",this).length){const e=this.textContent?.trim();if(!e)return;e in n&&o.push(finder(this))}})),o}(t,n),n)}function $(e,t){let n=0,a=e.slice();for(const t of e){let e=t.matchAll(/nth\-child\((\d+):(\d+)\)/g);e=Array.from(e);let[o,i]=[+e[0][1],+e[0][2]];a.splice(n,1),n--;for(let t=0;t<i-o+1;t++)a.push(e[0].input.replace(`${o}:${i}`,""+(o+t)));n++}return--t?$(a,t):a}function b(){p("偵測到本本");const n=e("#gallery_id").hide().text().replace("#","");e(e(`<h3 class="title"><span class="before">神的語言：</span><a id="book_id" class="god" data-clipboard-text="${n}" href="javascript:;">${n}</a></h3>`)).insertAfter("#gallery_id");const a=new ClipboardJS(".god");a.on("success",(e=>{p(`操作：${e.action}, 文字：${e.text}, 觸發：${e.trigger}`),r.dismissAll(),r.success("複製成功"),e.clearSelection()})),a.on("error",(e=>{p(`操作：${e.action}, 觸發：${e.trigger}`),r.dismissAll(),r.error("復製失敗")}));for(let t=1,n=Object.keys(o.Book.TagsName).length,a="";t<=n;t++)a=e(`#tags > .tag-container:nth-child(${t}) > span`)[0].outerHTML,f(`#tags > .tag-container:nth-child(${t})`,`${o.Book.TagsName[Object.keys(o.Book.TagsName).sort(((e,t)=>e-t))[t-1]]} ${a}`);g(e("#tags > .tag-container .tags a .name")),e("#download").hide(),e("#info > .buttons").prepend(`<a href="/g/${n}/1/?onePageMode=True" class="btn btn-primary"><i class="fas fa-book-open"></i> ${o.Book.Btns.Read}</a>`);let s=2===e("#info .title").length?`${e("#info .title:nth-child(1) > .pretty").text()}`:3===e("#info .title").length?`${e("#info .title:nth-child(2) > .pretty").text()}`:null,c=3===e("#info .title").length?`${e("#info .title:nth-child(1) > .pretty").text()}`:null,l="",d=0,m=s.split(" "),$=1===m.length?m.length:m.length-1,b=["Ch.","Ep.","第","話","券","前篇","中篇","後篇","+","-","#"],y=[" ","「","」"];for(let e=0;e<$;e++)l+=`${m[e]}+`;!function n(a,i=!0){function s(e,t=""){for(let n=0,o=e.length;n<o;n++)a=a.replaceAll(e[n],t)}3!=d&&(d++,i&&(a=a.replace(/[0-9]+/g,""),s(b),s(y,"+")),e.ajax({type:"GET",url:`/search/?q=${a}`,cache:t,dataType:"html",success:t=>{p(`搜尋 ${a} 讀取成功`);let i=e("<div></div>").html(t).find("#content > h1").text().replace("results",""),s=/69696969/.test(t.replace(c,"69696969"));if(p(`搜尋 結果數量：${i}`),i>0&&s)p("完美搜尋結果"),r(a);else switch(d){case 1:3===e("#info .title").length?n(c):(p("跳過搜尋 searchText2 ，搜尋 searchText3"),n(l,!1));break;case 2:i>0&&s?(p("完美搜尋結果"),r(a)):n(l,!1);break;case 3:p("勉強搜尋結果"),r(a)}function r(t){e("#info > .buttons").append(`<a href="/search/?q=${t}" class="btn btn-secondary"><i class="fas fa-search"></i> ${o.Book.Btns.SerachRelatedBook} (<span>${i.replaceAll(" ","")}</span>)</a>`)}},error:()=>{p(`搜尋 ${a} 讀取失敗`)}}))}(s);const k=e(".thumb-container").length;k>75&&(p(`總共頁數：：${k}，確定大於 75 `),f("#show-more-images-button",`<i class="fa fa-eye"></i> &nbsp; <span class="text">${o.Book.ShowMoreImagesButton}</span>`),f("#show-all-images-button",`<i class="fa fa-eye"></i> &nbsp; <span class="text">${o.Book.ShowAllImagesButton}</span>`)),f("#related-container > h2",o.Book.MoreLikeThis),h(),f("#comment-post-container > h3",`<i class="fa fa-comments color-icon"></i> ${o.Book.PostAComment}`),i?(e("#comment_form > textarea").attr("placeholder",`${o.Book.CommentFormPlaceHolder}`),f("#comment_form > div > button",`<i class="fa fa-comment"></i> ${o.Book.Comment}`)):f("#comment-post-container > div > p",`<a class="login-comment" href="/login/">${o.Book.NoLogin.Login}</a> ${o.Book.NoLogin.Or} <a class="login-comment" href="/register/">${o.Book.NoLogin.Register}</a> ${o.Book.NoLogin.ToPostAComment}`),f("time",u(e("time").html())),e("time").bind("DOMNodeInserted",(function(){let e=u(this.innerHTML);this.innerHTML!==e&&(this.innerHTML=e,p(`偵測到時間發生變化：${this.innerHTML}`))}))}function y(){p("偵測到首頁"),f("#content .index-popular > h2",`<i class="fa fa-fire color-icon"></i> ${o.Homepage.PopularNow}`),f("#content .container:nth-child(3) > h2",`<i class="fa fa-box-tissue color-icon"></i> ${o.Homepage.NewUploads}`),h(),p("自動翻頁 已開啟"),d("homepage"),s=1,l("homepage")}function k(){p("偵測到頁面列表"),h(),p("自動翻頁 已開啟"),d("page"),s=Number(location.href.split("=")[1]),l("page")}function w(){p("偵測到閱讀本本中"),/onePageMode=True/.test(location.href)?function(){p("自動翻頁 已開啟");let n=location.href.split("/"),a=Number(n[n.length-2]),o=Number(e("span.num-pages").eq(1).text()),i=n[n.length-3],s=1,c=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&(s=Number(e(t.target).attr("id").replace("page","")),f("span.current",s))}))}),{root:null,rootMargin:"0px",threshold:[0,1]});function l(t){e("html, body").animate({scrollTop:e(`#page${t}`).offset().top},"fast")}e("nav, #messages, #image-container, .reader-bar:last, .reader-settings, .reader-pagination").hide(),e(".reader-bar").append(`<div style="display:flex;align-self:flex-center;position:absolute;left:50%;transform:translateX(-50%)"><button class="page-number btn btn-unstyled"><span class="current">0</span><span class="divider">&nbsp;/&nbsp;</span><span class="num-pages">${o}</span></button></div>`),e(".reader-bar").eq(0).css({opacity:"0",position:"fixed",top:"0",width:"100%","z-index":"999999"}).hover((function(){e(this).animate({opacity:"1.0"},100)}),(function(){e(this).animate({opacity:"0"},100)})),e(window).keyup((t=>{switch(e(".reader-pagination > a").remove(),t.code){case"ArrowRight":s++,s<=o?l(s):s--;break;case"ArrowLeft":s--,s>=1?l(s):s++}})),function n(s){s>o?r.success("全部讀取完畢"):e.ajax({type:"GET",url:`/g/${i}/${s}/`,cache:t,dataType:"html",success:t=>{p(`第 ${s} 張 讀取成功`);let o=e("<div></div>");e("#content").append(o.html(t).find("#image-container > a > img").attr("id",`page${s}`).css({display:"block",margin:"0px auto"})),s==a&&l(a),c.observe(e(`#page${s}`)[0]),n(s+1)},error:()=>{p(`第 ${s} 張 讀取失敗`),r.dismissAll(),r.error(`第 ${s} 張 讀取失敗`),n(s)}})}(1)}():p("自動翻頁 已關閉")}function v(){p("偵測到 span 頁面");const t=o.spanPage,n=t.sort,a=e("#content > h1 > span"),i=a.html();t.tags.hasOwnProperty(i)?a.html(t.tags[i]).parent():p("未知的 span 頁面"),g(e("#content > h1 > a > .name")),f(".sort > div:nth-child(1) > a",n.Recent),f(".sort > div:nth-child(2) > span",n.Popular),f(".sort > div:nth-child(2) > a:nth-child(2)",n.today),f(".sort > div:nth-child(2) > a:nth-child(3)",n.week),f(".sort > div:nth-child(2) > a:nth-child(4)",n.allTime),d("span");const c=location.href.split("=");s=1==c.length?1:Number(c[1]),l("span")}e("nav, #content").hide(),e((()=>{const s=()=>{e.ajax({type:"GET",url:"//raw.githubusercontent.com/NekoChanTaiwan/nHentai-Enhanced/main/locales/zh_TW.json?flush_cache=True",cache:t,dataType:"json",success:t=>{p("JSON 讀取成功"),o=t,function(){if(e("head").append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.9.0/notyf.min.css">'),e('nav[role="navigation"]')[0])try{t=function(t={}){const a=(e,n,a)=>t[e]={condition:n,func:a};a("主頁",e("#content .index-popular")[0],y),a("頁面列表",e(".index-container")[0]&&/net\/\?page=/.test(location.href),k),a("本本",e("#tags")[0],b),a("閱讀模式",e("#image-container")[0],w),a("span 頁面",e("#content > h1 > span")[0],v);for(let e of Object.keys(t))if(p(`正在偵測頁面：${e}`),t[e].condition){t[e].func();break}e("#content").show(),p("隱藏黑名單 已關閉"),p("Discord 聊天室 已關閉"),p("阻擋廣告 已開啟"),e(".advertisement").hide(),n.ads=null},p("偵測到導航欄"),e(window).scroll((()=>{e("nav").css({position:"static",top:"0",width:"100%","z-index":"999999"}),0===e(window).scrollTop()?e("nav").css({position:"static"}):pageYOffset>=e("nav")[0].offsetTop&&e("nav").css({position:"fixed"})})),m(["#content"],o.MenuLeft),Object.keys(n.options.user).length?(f(".menu.right li:nth-child(1) > a",`<i class="fa fa-heart color-icon"></i> ${o.MenuRight2.Favroites}`),f(".menu.right li:nth-child(3) > a",`<i class="fa fa-sign-out-alt"></i> ${o.MenuRight2.LogOut}`),i=!0):(f(".menu.right li:nth-child(1) > a",`<i class="fa fa-sign-in-alt"></i> ${o.MenuRight1.SignIn}`),f(".menu.right li:nth-child(2) > a",`<i class="fa fa-edit"></i> ${o.MenuRight1.Register}`),i=!1),e(".menu.right").prepend('\n    <li class="desktop "><a target="_blank" href="https://github.com/NekoChanTaiwan/nHentai-downloader/releases/latest"><i class="fas fa-download"></i> &nbsp nHentai-downloader</a></li>\n    <li class="desktop "><a target="_blank" href="https://discord.gg/ekbWahg52h"><i class="fab fa-discord"></i> &nbsp Discord - nHentai-Enhanced</a></li>'),e("input[type=search]").attr({autocomplete:"off",placeholder:""}),function(t,n=t.length){for(let a=0;a<n;a++)p(`新增自定選單：${Object.keys(t[a])[0]} 連結：${Object.values(t[a])[0]}`),e(".menu.left").append(`<li class="desktop "><a href="${Object.values(t[a])[0]}">${Object.keys(t[a])[0]}</a></li>`)}(a),t(),e("nav").show()}catch(e){p("初始化失敗："+e),r.error("nHentai-Enhanced 初始化失敗："+e)}else p('nav 初始化失敗，找不到指定的元素：nav[role="navigation"]'),e("nav, #content").show();var t}()},error:()=>{p("JSON 讀取失敗 3 秒後重新讀取"),setTimeout((()=>s()),3e3)}})};s()}))})();